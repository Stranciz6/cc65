
# makefile for the remaining tests that need special care in one way or another

ifneq ($(shell echo),)
  CMD_EXE = 1
endif

CC65FLAGS = -t sim6502
SIM65FLAGS = -x 200000000

CL65 := $(if $(wildcard ../../bin/cl65*),../../bin/cl65,cl65)
SIM65 := $(if $(wildcard ../../bin/sim65*),../../bin/sim65,sim65)

ifdef CMD_EXE
RM := del /f
else
RM := rm -f
endif

WORKDIR := ./../../testwrk

DIFF := $(WORKDIR)/bdiff

.PHONY: all clean

TESTS := $(patsubst %.c,%.prg,$(wildcard *.c))
TESTS += $(patsubst %.c,%.o.prg,$(wildcard *.c))
TESTS += $(patsubst %.c,%.os.prg,$(wildcard *.c))
TESTS += $(patsubst %.c,%.osi.prg,$(wildcard *.c))
TESTS += $(patsubst %.c,%.osir.prg,$(wildcard *.c))
TESTS += $(patsubst %.c,%.oi.prg,$(wildcard *.c))
TESTS += $(patsubst %.c,%.oir.prg,$(wildcard *.c))
TESTS += $(patsubst %.c,%.or.prg,$(wildcard *.c))

all: $(TESTS)

# should compile, but then hangs in an endless loop
endless%prg: endless.c
	$(CL65) $(CC65FLAGS) $< -o $@
	! $(SIM65) $(SIM65FLAGS) $@

# these need reference data that cant be generated by a host compiled program
# in a useful way
limits%prg: limits.c
	$(CL65) $(CC65FLAGS) $< -o $@
	$(SIM65) $(SIM65FLAGS) $@ > limits.out
	$(DIFF) limits.out limits.ref

# the rest are tests that fail currently for one reason or another
fields%prg: fields.c
	@echo "FIXME: " $@ "will currently fail"
	$(CL65) $(CC65FLAGS) $< -o $@
	-$(SIM65) $(SIM65FLAGS) $@
sitest%prg: sitest.c
	@echo "FIXME: " $@ "will currently fail"
	-$(CL65) $(CC65FLAGS) $< -o $@
	-$(SIM65) $(SIM65FLAGS) $@

clean:
	@$(RM) *.o
	@$(RM) *.prg
	@$(RM) *.out

